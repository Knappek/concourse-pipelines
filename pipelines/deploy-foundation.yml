# reference pipeline: https://docs.vmware.com/en/Platform-Automation-Toolkit-for-VMware-Tanzu/5.2/vmware-automation-toolkit/GUID-docs-pipelines-multiple-products.html

groups:
- jobs:
    - test-platform-automation
    - install-opsman
    - export-installation
    - upgrade-opsman
    # - expiring-certificates
    - delete-installation
    - download-upload-and-stage-healthwatch-pas-exporter
    # - download-upload-and-stage-healthwatch-pks-exporter
    - download-upload-and-stage-healthwatch
    - download-upload-and-stage-tas
    - download-upload-and-stage-isolation-segment
    # - download-upload-and-stage-pks
    - configure-healthwatch-pas-exporter
    # - configure-healthwatch-pks-exporter
    - configure-healthwatch
    - configure-tas
    - configure-ncp
    - configure-isolation-segment
    - configure-isolation-segment-bank
    # - configure-pks
    - apply-main-product-changes
    - apply-subproduct-changes
    # - collect-telemetry
    # - stage-configure-apply-telemetry
  name: deploy-foundation
# - jobs:
#     - create-root-ca
#     - apply-new-ca
#     - activate-new-ca-and-regenerate-certs
#     - apply-certificates
#     - cleanup-ca-certificate-authorities
#   name: certificate-rotation

resource_types:
- name: s3
  type: docker-image
  source:
    repository: concourse/s3-resource
    tag: 1.2.1-ubuntu

resources:
- name: platform-automation-tasks
  type: git
  source:
    private_key: ((pipeline-git-repo-key.private_key))
    uri: ((pipeline-git-repo-uri))
    branch: main
    depth: 1

- name: platform-automation-image
  type: s3
  source:
    endpoint: ((s3_endpoint))
    disable_ssl: true
    access_key_id: ((s3_access_key_id))
    secret_access_key: ((s3_secret_access_key))
    bucket: ((s3_pivnet_products_bucket))
    regexp: platform-automation-image-(.*).tgz

- name: cf
  type: registry-image
  source:
    repository: cloudfoundry/cli
    tag: "8"

# - name: telemetry-collector-binary
#   type: s3
#   source:
#     endpoint: ((s3_endpoint))
#     disable_ssl: true
#     access_key_id: ((s3_access_key_id))
#     secret_access_key: ((s3_secret_access_key))
#     bucket: ((s3_pivnet_products_bucket))
#     regexp: .*telemetry-(.*).tgz

- name: installation
  type: s3
  source:
    endpoint: ((s3_endpoint))
    disable_ssl: true
    access_key_id: ((s3_access_key_id))
    secret_access_key: ((s3_secret_access_key))
    bucket: ((s3_installation_bucket))
    regexp: ((foundation))-installation-(.*).zip

# VM state and foundation configuration
- name: state
  type: s3
  source:
    endpoint: ((s3_endpoint))
    disable_ssl: true
    access_key_id: ((s3_access_key_id))
    secret_access_key: ((s3_secret_access_key))
    bucket: ((s3_foundation_state_bucket))
    versioned_file: state-((foundation)).yml
    initial_content_text: '{}'
    initial_version: 'empty-start'

# configurations
- name: configuration
  type: git
  source:
    private_key: ((pipeline-git-repo-key.private_key))
    uri: ((pipeline-git-repo-uri))
    branch: main
    depth: 1

- name: custom-tasks
  type: git
  source:
    private_key: ((pipeline-git-repo-key.private_key))
    uri: ((pipeline-git-repo-uri))
    branch: main
    depth: 1

# triggers used to have jobs do something in a timely manner
- name: one-time-trigger
  type: time
  source:
    interval: 999999h

prepare-tasks-with-secrets: &prepare-tasks-with-secrets
  image: platform-automation-image
  file: platform-automation-tasks/tasks/prepare-tasks-with-secrets.yml
  input_mapping:
    tasks: platform-automation-tasks
    config: configuration
    vars: configuration
  params:
    CONFIG_PATHS: config/foundations/config config/foundations/((foundation))/config
    VARS_PATHS: vars/foundations/((foundation))/vars
  output_mapping:
    tasks: platform-automation-tasks
    interval: 999999h

prepare-tasks-with-secrets-for-custom-tasks: &prepare-tasks-with-secrets-for-custom-tasks
  image: platform-automation-image
  file: platform-automation-tasks/tasks/prepare-tasks-with-secrets.yml
  input_mapping:
    tasks: custom-tasks
    config: configuration
    vars: configuration
  params:
    CONFIG_PATHS: config/foundations/config config/foundations/((foundation))/config
    VARS_PATHS: vars/foundations/((foundation))/vars
  output_mapping:
    tasks: custom-tasks

jobs:
- name: test-platform-automation
  serial: true
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: platform-automation-tasks
      - get: configuration
    # code_snippet test-interpolate-usage start yaml
    - task: test-interpolate
      image: platform-automation-image
      file: platform-automation-tasks/tasks/test-interpolate.yml
      params:
        CONFIG_FILE: foundations/((foundation))/config/download-tas.yml
        SKIP_MISSING: true
      input_mapping:
        config: configuration
    # code_snippet test-interpolate-usage end
    # code_snippet test-usage start yaml
    - task: test
      file: platform-automation-tasks/tasks/test.yml
      image: platform-automation-image
  # code_snippet test-usage end

- name: install-opsman
  serial: true
  serial_groups: [ install ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: one-time-trigger
      trigger: true
    - get: platform-automation-tasks
    - get: configuration
    - get: state
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: download-opsman-image
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    input_mapping:
      config: configuration
      vars: configuration
    params:
      CONFIG_FILE: foundations/((foundation))/config/download-opsman.yml
      VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
      SOURCE: s3
    output_mapping:
      downloaded-product: opsman-image
  # code_snippet create-vm-usage start yaml
  - task: create-vm
    image: platform-automation-image
    file: platform-automation-tasks/tasks/create-vm.yml
    input_mapping:
      image: opsman-image
      config: configuration
      vars: configuration
    params:
      OPSMAN_CONFIG_FILE: foundations/((foundation))/config/opsman.yml
      STATE_FILE: state-((foundation)).yml
      VARS_FILES: vars/foundations/((foundation))/vars/director.yml
    ensure: &put-state
      do:
      - put: state
        params:
          file: generated-state/state-((foundation)).yml
  # code_snippet create-vm-usage end
  # code_snippet configure-authentication-usage start yaml
  - task: configure-authentication
    image: platform-automation-image
    file: platform-automation-tasks/tasks/configure-authentication.yml
    attempts: 20
    input_mapping:
      env: configuration
      config: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      AUTH_CONFIG_FILE: foundations/config/auth.yml
  # code_snippet configure-authentication-usage end
  # code_snippet configure-opsman-usage start yaml
  - task: configure-opsman
    image: platform-automation-image
    file: platform-automation-tasks/tasks/configure-opsman.yml
    input_mapping:
      env: configuration
      config: configuration
      vars: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      OPSMAN_CONFIG_FILE: foundations/((foundation))/config/opsman.yml
      VARS_FILES: vars/foundations/((foundation))/vars/director.yml
  # code_snippet configure-opsman-usage end
  # code_snippet configure-director-usage start yaml
  - task: configure-director
    image: platform-automation-image
    file: platform-automation-tasks/tasks/configure-director.yml
    input_mapping:
      config: configuration
      env: configuration
      vars: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      DIRECTOR_CONFIG_FILE: foundations/((foundation))/config/director.yml
      # TODO: needed in VARS_FILES??? => vars/foundations/((foundation))/vars/tas.yml
      VARS_FILES: |
        vars/foundations/((foundation))/vars/director.yml
  # code_snippet configure-director-usage end
  # code_snippet apply-director-changes-usage start yaml
  - task: apply-director-changes
    image: platform-automation-image
    attempts: 3
    file: platform-automation-tasks/tasks/apply-director-changes.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  # code_snippet apply-director-changes-usage end
  # TODO: Do I need this at all? It's also done in the next job? https://chat.google.com/room/AAAAzqe3vEo/3xkeBPRfb9w/ihhT8NKgGSs?cls=10
  # - task: export-installation
  #   image: platform-automation-image
  #   file: platform-automation-tasks/tasks/export-installation.yml
  #   input_mapping:
  #     env: configuration
  #   params:
  #     INSTALLATION_FILE: ((foundation))-installation-$timestamp.zip
  #     ENV_FILE: foundations/config/env.yml
  # - put: installation
  #   params:
  #     file: installation/((foundation))-installation*.zip

- name: export-installation
  serial_groups: [ install ]
  serial: true
  plan:
  - in_parallel:
    - get: state
      passed: [ install-opsman ]
      trigger: true
    - get: platform-automation-image
      params:
        unpack: true
    - get: platform-automation-tasks
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  # code_snippet revert-staged-changes-usage start yaml
  - task: revert-staged-changes
    image: platform-automation-image
    file: platform-automation-tasks/tasks/revert-staged-changes.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  # code_snippet revert-staged-changes-usage end
  - do: &export-installation
    - task: export-installation
      image: platform-automation-image
      file: platform-automation-tasks/tasks/export-installation.yml
      input_mapping:
        env: configuration
      params:
        ENV_FILE: foundations/config/env.yml
        INSTALLATION_FILE: ((foundation))-installation-$timestamp.zip
    - put: installation
      params:
        file: installation/((foundation))-installation*.zip

- name: upgrade-opsman
  serial: true
  serial_groups: [ install ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: platform-automation-tasks
    - get: installation
      passed: 
      - export-installation
    - get: state
      trigger: true
      passed: 
      - install-opsman
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: download-opsman-image
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    input_mapping:
      config: configuration
      vars: configuration
    params:
      CONFIG_FILE: foundations/((foundation))/config/download-opsman.yml
      VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
      SOURCE: s3
    output_mapping:
      downloaded-product: opsman-image
  # code_snippet upgrade-opsman-usage start yaml
  - task: upgrade-opsman
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upgrade-opsman.yml
    input_mapping:
      image: opsman-image
      config: configuration
      env: configuration
      vars: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      OPSMAN_CONFIG_FILE: foundations/((foundation))/config/opsman.yml
      STATE_FILE: state-((foundation)).yml
      INSTALLATION_FILE: ((foundation))-installation*.zip
      VARS_FILES: vars/foundations/((foundation))/vars/director.yml
    ensure: *put-state
  # code_snippet upgrade-opsman-usage end
  - task: configure-director
    image: platform-automation-image
    file: platform-automation-tasks/tasks/configure-director.yml
    input_mapping:
      config: configuration
      env: configuration
      vars: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      DIRECTOR_CONFIG_FILE: foundations/((foundation))/config/director.yml
      VARS_FILES: |
        vars/foundations/((foundation))/vars/director.yml
        vars/foundations/((foundation))/vars/tas.yml
  - task: apply-director-changes
    image: platform-automation-image
    file: platform-automation-tasks/tasks/apply-director-changes.yml
    attempts: 3
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - do: *export-installation

- name: download-upload-and-stage-tas
  serial: true
  serial_groups: [ products ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: state
      trigger: true
      passed: [ "upgrade-opsman" ]
    - get: platform-automation-tasks
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: download-tas
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    input_mapping:
      config: configuration
      vars: configuration
    params:
      CONFIG_FILE: foundations/((foundation))/config/download-tas.yml
      VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
      SOURCE: s3
    output_mapping:
      downloaded-product: tas-product
      downloaded-stemcell: tas-stemcell
  - task: download-ncp
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    input_mapping:
      config: configuration
      vars: configuration
    params:
      CONFIG_FILE: foundations/((foundation))/config/download-ncp.yml
      VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
      SOURCE: s3
    output_mapping:
      downloaded-product: ncp-product
  - task: upload-tas-product
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-product.yml
    input_mapping:
      product: tas-product
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: upload-ncp-product
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-product.yml
    input_mapping:
      product: ncp-product
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: upload-tas-stemcell
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-stemcell.yml
    input_mapping:
      env: configuration
      stemcell: tas-stemcell
    params:
      ENV_FILE: foundations/config/env.yml
  - task: stage-tas
    image: platform-automation-image
    file: platform-automation-tasks/tasks/stage-product.yml
    input_mapping:
      product: tas-product
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: stage-ncp
    image: platform-automation-image
    file: platform-automation-tasks/tasks/stage-product.yml
    input_mapping:
      product: ncp-product
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml


# - name: download-upload-and-stage-pks
#   serial: true
#   serial_groups: [ products ]
#   plan:
#   - in_parallel:
#     - get: platform-automation-image
#       params:
#         unpack: true
#     - get: state
#       trigger: true
#       passed: [ "upgrade-opsman" ]
#     - get: platform-automation-tasks
#     - get: configuration
#   - task: prepare-tasks-with-secrets
#     <<: *prepare-tasks-with-secrets
#   - task: download-pks
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/download-product.yml
#     input_mapping:
#       config: configuration
#       vars: configuration
#     params:
#       CONFIG_FILE: foundations/((foundation))/config/download-pks.yml
#       VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
#       SOURCE: s3
#     output_mapping:
#       downloaded-product: pks-product
#       downloaded-stemcell: pks-stemcell
#   - task: upload-pks-product
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/upload-product.yml
#     input_mapping:
#       product: pks-product
#       env: configuration
#     params:
#       ENV_FILE: foundations/config/env.yml
#   - task: upload-pks-stemcell
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/upload-stemcell.yml
#     input_mapping:
#       env: configuration
#       stemcell: pks-stemcell
#     params:
#       ENV_FILE: foundations/config/env.yml
#   - task: stage-pks
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/stage-product.yml
#     input_mapping:
#       product: pks-product
#       env: configuration
#     params:
#       ENV_FILE: foundations/config/env.yml

- name: configure-tas
  serial: true
  serial_groups: [ install ]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: state
        trigger: true
        passed: [ "download-upload-and-stage-tas" ]
      - get: platform-automation-tasks
      - get: configuration
      - get: custom-tasks
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: generate-certificate-for-gorouter
      image: platform-automation-image
      file: platform-automation-tasks/tasks/generate-certificate.yml
      input_mapping:
        env: configuration
      params:
        DOMAINS: "*.apps.((tas_domain)),*.sys.((tas_domain)),*.login.((tas_domain)),*.uaa.sys.((tas_domain))"
        ENV_FILE: foundations/config/env.yml
      output_mapping:
        certificate: gorouter-certificate
    - task: interpolate-gorouter-certs
      image: platform-automation-image
      file: custom-tasks/custom-tasks/interpolate-runtime-vars-from-files.yml
      input_mapping:
        config: configuration
        vars: configuration
        files: gorouter-certificate
      params:
        CONFIG_PATH: config/foundations/((foundation))/vars/gorouter-certs-vars-tmpl.yml
        VAR_FILEPATH_MAPPING: tas_gorouter_ssl_cert:certificate.pem tas_gorouter_ssl_key:privatekey.pem
        VARS_OUTPUT_PATH: vars/foundations/((foundation))/vars
        RUNTIME_VARS_FILENAME: gorouter-certs.yml
      output_mapping:
        vars: vars-interpolated
    - task: generate-certificate-for-uaa
      image: platform-automation-image
      file: platform-automation-tasks/tasks/generate-certificate.yml
      input_mapping:
        env: configuration
      params:
        DOMAINS: "*.login.sys.((tas_domain))"
        ENV_FILE: foundations/config/env.yml
      output_mapping:
        certificate: uaa-certificate
    - task: interpolate-uaa-certs
      image: platform-automation-image
      file: custom-tasks/custom-tasks/interpolate-runtime-vars-from-files.yml
      input_mapping:
        config: configuration
        vars: vars-interpolated
        files: uaa-certificate
      params:
        CONFIG_PATH: config/foundations/((foundation))/vars/uaa-certs-vars-tmpl.yml
        VAR_FILEPATH_MAPPING: tas_uaa_certificate:certificate.pem tas_uaa_private_key:privatekey.pem
        VARS_OUTPUT_PATH: vars/foundations/((foundation))/vars
        RUNTIME_VARS_FILENAME: uaa-certs.yml
      output_mapping:
        vars: vars-interpolated
    - task: configure-tas
      image: platform-automation-image
      file: platform-automation-tasks/tasks/configure-product.yml
      input_mapping:
        config: configuration
        env: configuration
        vars: vars-interpolated
      params:
        CONFIG_FILE: foundations/((foundation))/config/tas.yml
        ENV_FILE: foundations/config/env.yml
        VARS_FILES: |
          vars/foundations/((foundation))/vars/tas.yml
          vars/foundations/((foundation))/vars/director.yml
          vars/foundations/((foundation))/vars/gorouter-certs.yml
          vars/foundations/((foundation))/vars/uaa-certs.yml

- name: configure-ncp
  serial: true
  serial_groups: [ install ]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: state
        trigger: true
        passed: [ "download-upload-and-stage-tas" ]
      - get: platform-automation-tasks
      - get: configuration
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: configure-ncp
      image: platform-automation-image
      file: platform-automation-tasks/tasks/configure-product.yml
      input_mapping:
        config: configuration
        env: configuration
        vars: configuration
      params:
        CONFIG_FILE: foundations/((foundation))/config/ncp.yml
        ENV_FILE: foundations/config/env.yml
        VARS_FILES: |
          vars/foundations/((foundation))/vars/ncp.yml
          vars/foundations/((foundation))/vars/director.yml

# - name: configure-pks
#   serial: true
#   serial_groups: [ install ]
#   plan:
#     - in_parallel:
#       - get: platform-automation-image
#         params:
#           unpack: true
#       - get: state
#         trigger: true
#         passed: [ "download-upload-and-stage-pks" ]
#       - get: platform-automation-tasks
#       - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     - task: configure-pks
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/configure-product.yml
#       input_mapping:
#         config: configuration
#         env: configuration
#         vars: configuration
#       params:
#         CONFIG_FILE: foundations/((foundation))/config/pks.yml
#         ENV_FILE: foundations/config/env.yml
#         VARS_FILES: |
#           vars/foundations/((foundation))/vars/pks.yml
#           vars/foundations/((foundation))/vars/director.yml

- name: apply-main-product-changes
  serial: true
  serial_groups: [ install ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: state
      passed:
      - configure-tas
      - configure-ncp
      # - configure-pks
      trigger: true
    - get: platform-automation-tasks
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: pre-deploy-check
    image: platform-automation-image
    file: platform-automation-tasks/tasks/pre-deploy-check.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: apply-product-changes
    attempts: 3
    image: platform-automation-image
    file: platform-automation-tasks/tasks/apply-changes.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      # SELECTIVE_DEPLOY_PRODUCTS: "p-bosh,cf,VMware-NSX-T,pivotal-container-service"
      SELECTIVE_DEPLOY_PRODUCTS: "p-bosh,cf,VMware-NSX-T"
  - task: check-pending-changes
    image: platform-automation-image
    file: platform-automation-tasks/tasks/check-pending-changes.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      ALLOW_PENDING_CHANGES: true
  - task: export-installation
    image: platform-automation-image
    file: platform-automation-tasks/tasks/export-installation.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      INSTALLATION_FILE: ((foundation))-installation-$timestamp.zip
  - put: installation
    params:
      file: installation/((foundation))-installation*.zip

- name: download-upload-and-stage-healthwatch
  serial: true
  serial_groups: [ products ]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: state
        trigger: true
        passed: [ "apply-main-product-changes" ]
      - get: platform-automation-tasks
      - get: configuration
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: download-healthwatch
      image: platform-automation-image
      file: platform-automation-tasks/tasks/download-product.yml
      input_mapping:
        config: configuration
        vars: configuration
      params:
        CONFIG_FILE: foundations/((foundation))/config/download-healthwatch.yml
        VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
        SOURCE: s3
      output_mapping:
        downloaded-product: healthwatch-product
        downloaded-stemcell: healthwatch-stemcell
    - task: upload-and-stage-healthwatch
      image: platform-automation-image
      file: platform-automation-tasks/tasks/upload-and-stage-product.yml
      input_mapping:
        product: healthwatch-product
        env: configuration
      params:
        ENV_FILE: foundations/config/env.yml
    - task: upload-healthwatch-stemcell
      image: platform-automation-image
      file: platform-automation-tasks/tasks/upload-stemcell.yml
      input_mapping:
        env: configuration
        stemcell: healthwatch-stemcell
      params:
        ENV_FILE: foundations/config/env.yml

- name: download-upload-and-stage-healthwatch-pas-exporter
  serial: true
  serial_groups: [ products ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: state
      trigger: true
      passed: 
      - download-upload-and-stage-healthwatch
    - get: platform-automation-tasks
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: download-healthwatch-pas-exporter
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    input_mapping:
      config: configuration
      vars: configuration
    params:
      CONFIG_FILE: foundations/((foundation))/config/download-healthwatch-pas-exporter.yml
      VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
      SOURCE: s3
    output_mapping:
      downloaded-product: healthwatch-pas-exporter
  - task: upload-and-stage-healthwatch-pas-exporter
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-and-stage-product.yml
    input_mapping:
      product: healthwatch-pas-exporter
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml

# - name: download-upload-and-stage-healthwatch-pks-exporter
#   serial: true
#   serial_groups: [ products ]
#   plan:
#   - in_parallel:
#     - get: platform-automation-image
#       params:
#         unpack: true
#     - get: state
#       trigger: true
#       passed: 
#       - download-upload-and-stage-healthwatch
#     - get: platform-automation-tasks
#     - get: configuration
#   - task: prepare-tasks-with-secrets
#     <<: *prepare-tasks-with-secrets
#   - task: download-healthwatch-pks-exporter
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/download-product.yml
#     input_mapping:
#       config: configuration
#       vars: configuration
#     params:
#       CONFIG_FILE: foundations/((foundation))/config/download-healthwatch-pks-exporter.yml
#       VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
#       SOURCE: s3
#     output_mapping:
#       downloaded-product: healthwatch-pks-exporter
#   - task: upload-and-stage-healthwatch-pks-exporter
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/upload-and-stage-product.yml
#     input_mapping:
#       product: healthwatch-pks-exporter
#       env: configuration
#     params:
#       ENV_FILE: foundations/config/env.yml

- name: download-upload-and-stage-isolation-segment
  serial: true
  serial_groups: [ products ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: state
      trigger: true
      passed: [ "apply-main-product-changes" ]
    - get: platform-automation-tasks
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: download-isolation-segment
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    input_mapping:
      config: configuration
      vars: configuration
    params:
      CONFIG_FILE: foundations/((foundation))/config/download-isolation-segment.yml
      VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
      SOURCE: s3
    output_mapping:
      downloaded-product: isolation-segment
  - task: replicate-isolation-segment
    image: platform-automation-image
    file: platform-automation-tasks/tasks/replicate-product.yml
    input_mapping:
      product: isolation-segment
    params:
      REPLICATED_NAME: "Iso Bank"
    output_mapping:
      replicated-product: isolation-segment-bank
  - task: upload-isolation-segment
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-product.yml
    input_mapping:
      product: isolation-segment
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: upload-isolation-segment-bank
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-product.yml
    input_mapping:
      product: isolation-segment-bank
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: stage-isolation-segment
    image: platform-automation-image
    file: platform-automation-tasks/tasks/stage-product.yml
    input_mapping:
      product: isolation-segment
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: stage-isolation-segment-bank
    image: platform-automation-image
    file: platform-automation-tasks/tasks/stage-product.yml
    input_mapping:
      product: isolation-segment-bank
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml

- name: download-upload-and-stage-postgres
  serial: true
  serial_groups: [ products ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: state
      trigger: true
      passed: [ "apply-main-product-changes" ]
    - get: platform-automation-tasks
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: download-postgres
    image: platform-automation-image
    file: platform-automation-tasks/tasks/download-product.yml
    input_mapping:
      config: configuration
      vars: configuration
    params:
      CONFIG_FILE: foundations/((foundation))/config/download-postgres.yml
      VARS_FILES: vars/foundations/((foundation))/vars/versions.yml
      SOURCE: s3
    output_mapping:
      downloaded-product: postgres
  - task: upload-postgres
    image: platform-automation-image
    file: platform-automation-tasks/tasks/upload-product.yml
    input_mapping:
      product: postgres
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: stage-postgres
    image: platform-automation-image
    file: platform-automation-tasks/tasks/stage-product.yml
    input_mapping:
      product: postgres
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml

- name: configure-healthwatch
  serial: true
  serial_groups: [ install ]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: state
        trigger: true
        passed:
          - download-upload-and-stage-healthwatch
      - get: platform-automation-tasks
      - get: configuration
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: configure-healthwatch
      image: platform-automation-image
      file: platform-automation-tasks/tasks/configure-product.yml
      input_mapping:
        config: configuration
        env: configuration
        vars: configuration
      params:
        CONFIG_FILE: foundations/((foundation))/config/healthwatch.yml
        ENV_FILE: foundations/config/env.yml
        VARS_FILES: |
          vars/foundations/((foundation))/vars/director.yml

- name: configure-healthwatch-pas-exporter
  serial: true
  serial_groups: [ install ]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: state
        passed:
          - download-upload-and-stage-healthwatch-pas-exporter
        trigger: true
      - get: platform-automation-tasks
      - get: configuration
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: configure-healthwatch-pas-exporter
      image: platform-automation-image
      file: platform-automation-tasks/tasks/configure-product.yml
      input_mapping:
        config: configuration
        env: configuration
        vars: configuration
      params:
        CONFIG_FILE: foundations/((foundation))/config/healthwatch-pas-exporter.yml
        ENV_FILE: foundations/config/env.yml
        VARS_FILES: |
          vars/foundations/((foundation))/vars/director.yml

# - name: configure-healthwatch-pks-exporter
#   serial: true
#   serial_groups: [ install ]
#   plan:
#     - in_parallel:
#       - get: platform-automation-image
#         params:
#           unpack: true
#       - get: state
#         passed:
#           - download-upload-and-stage-healthwatch-pks-exporter
#         trigger: true
#       - get: platform-automation-tasks
#       - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     - task: configure-healthwatch-pks-exporter
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/configure-product.yml
#       input_mapping:
#         config: configuration
#         env: configuration
#         vars: configuration
#       params:
#         CONFIG_FILE: foundations/((foundation))/config/healthwatch-pks-exporter.yml
#         ENV_FILE: foundations/config/env.yml
#         VARS_FILES: |
#           vars/foundations/((foundation))/vars/director.yml

- name: configure-isolation-segment
  serial: true
  serial_groups: [ install ]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: state
        trigger: true
        passed: 
        - download-upload-and-stage-isolation-segment
      - get: platform-automation-tasks
      - get: configuration
      - get: custom-tasks
      - get: cf
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: prepare-tasks-with-secrets-for-custom-tasks
      <<: *prepare-tasks-with-secrets-for-custom-tasks
    - task: get-cf-credentials
      image: platform-automation-image
      file: custom-tasks/custom-tasks/get-credentials.yml
      input_mapping:
        env: configuration
      params:
        ENV_FILE: foundations/config/env.yml
        PRODUCT: cf
        CREDENTIAL_REFERENCE: .uaa.admin_credentials
        CREDENTIAL_FIELD_TO_ENV_NAME_MAPPINGS: identity:CF_USERNAME password:CF_PASSWORD
      output_mapping:
        custom-credentials: cf-credentials
    - task: cf-create-shared-domain
      image: cf
      file: custom-tasks/custom-tasks/execute-cf-command.yml
      input_mapping:
        custom-tasks: custom-tasks
        cf-env: cf-credentials
        cf-command-file: configuration
      params:
        CF_API_URL: api.sys.((tas_domain))
        CF_SKIP_SSL_VALIDATION: true
        CF_ORG: system
        CF_SPACE: system
        CF_ENVIRONMENT_VARIABLES_FILE: cf-env/creds.yml 
        CF_COMMAND_FILE: cf-command-file/foundations/((foundation))/scripts/create_shared_domain.sh
        CF_COMMAND_FILE_INPUT_PARAMETERS: apps.((isolation_segment_domain))
      output_mapping:
        credentials: cf-credentials
    - task: generate-certificate-for-iso-segment-gorouter
      image: platform-automation-image
      file: platform-automation-tasks/tasks/generate-certificate.yml
      input_mapping:
        env: configuration
      params:
        DOMAINS: "172.30.7.30,*.apps.((isolation_segment_domain)),*.((isolation_segment_domain)),((isolation_segment_domain))"
        ENV_FILE: foundations/config/env.yml
      output_mapping:
        certificate: iso-segment-gorouter-certificate
    - task: interpolate-gorouter-certs
      image: platform-automation-image
      file: custom-tasks/custom-tasks/interpolate-runtime-vars-from-files.yml
      input_mapping:
        config: configuration
        vars: configuration
        files: iso-segment-gorouter-certificate
      params:
        CONFIG_PATH: config/foundations/((foundation))/vars/iso-segment-gorouter-certs-vars-tmpl.yml
        VAR_FILEPATH_MAPPING: iso_segment_gorouter_ssl_cert:certificate.pem iso_segment_gorouter_ssl_key:privatekey.pem
        VARS_OUTPUT_PATH: vars/foundations/((foundation))/vars
        RUNTIME_VARS_FILENAME: iso-segment-gorouter-certs.yml
      output_mapping:
        vars: vars-interpolated
    - task: configure-isolation-segment
      image: platform-automation-image
      file: platform-automation-tasks/tasks/configure-product.yml
      input_mapping:
        config: configuration
        env: configuration
        vars: vars-interpolated
      params:
        CONFIG_FILE: foundations/((foundation))/config/isolation-segment.yml
        ENV_FILE: foundations/config/env.yml
        VARS_FILES: |
          vars/foundations/((foundation))/vars/isolation-segment.yml
          vars/foundations/((foundation))/vars/director.yml
          vars/foundations/((foundation))/vars/iso-segment-gorouter-certs.yml

- name: configure-isolation-segment-bank
  serial: true
  serial_groups: [ install ]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: state
        trigger: true
        passed: 
        - download-upload-and-stage-isolation-segment
      - get: platform-automation-tasks
      - get: configuration
      - get: custom-tasks
      - get: cf
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: prepare-tasks-with-secrets-for-custom-tasks
      <<: *prepare-tasks-with-secrets-for-custom-tasks
    - task: get-cf-credentials
      image: platform-automation-image
      file: custom-tasks/custom-tasks/get-credentials.yml
      input_mapping:
        env: configuration
      params:
        ENV_FILE: foundations/config/env.yml
        PRODUCT: cf
        CREDENTIAL_REFERENCE: .uaa.admin_credentials
        CREDENTIAL_FIELD_TO_ENV_NAME_MAPPINGS: identity:CF_USERNAME password:CF_PASSWORD
      output_mapping:
        custom-credentials: cf-credentials
    - task: cf-create-shared-domain
      image: cf
      file: custom-tasks/custom-tasks/execute-cf-command.yml
      input_mapping:
        custom-tasks: custom-tasks
        cf-env: cf-credentials
        cf-command-file: configuration
      params:
        CF_API_URL: api.sys.((tas_domain))
        CF_SKIP_SSL_VALIDATION: true
        CF_ORG: system
        CF_SPACE: system
        CF_ENVIRONMENT_VARIABLES_FILE: cf-env/creds.yml 
        CF_COMMAND_FILE: cf-command-file/foundations/((foundation))/scripts/create_shared_domain.sh
        CF_COMMAND_FILE_INPUT_PARAMETERS: apps.((bank_isolation_segment_domain))
      output_mapping:
        credentials: cf-credentials
    - task: generate-certificate-for-iso-segment-gorouter
      image: platform-automation-image
      file: platform-automation-tasks/tasks/generate-certificate.yml
      input_mapping:
        env: configuration
      params:
        DOMAINS: "172.30.7.62,*.apps.((bank_isolation_segment_domain)),*.((bank_isolation_segment_domain)),((bank_isolation_segment_domain))"
        ENV_FILE: foundations/config/env.yml
      output_mapping:
        certificate: iso-segment-gorouter-certificate
    - task: interpolate-gorouter-certs
      image: platform-automation-image
      file: custom-tasks/custom-tasks/interpolate-runtime-vars-from-files.yml
      input_mapping:
        config: configuration
        vars: configuration
        files: iso-segment-gorouter-certificate
      params:
        CONFIG_PATH: config/foundations/((foundation))/vars/iso-segment-gorouter-certs-vars-tmpl.yml
        VAR_FILEPATH_MAPPING: iso_segment_gorouter_ssl_cert:certificate.pem iso_segment_gorouter_ssl_key:privatekey.pem
        VARS_OUTPUT_PATH: vars/foundations/((foundation))/vars
        RUNTIME_VARS_FILENAME: iso-segment-gorouter-certs.yml
      output_mapping:
        vars: vars-interpolated
    - task: configure-isolation-segment
      image: platform-automation-image
      file: platform-automation-tasks/tasks/configure-product.yml
      input_mapping:
        config: configuration
        env: configuration
        vars: vars-interpolated
      params:
        CONFIG_FILE: foundations/((foundation))/config/isolation-segment-bank.yml
        ENV_FILE: foundations/config/env.yml
        VARS_FILES: |
          vars/foundations/((foundation))/vars/isolation-segment-bank.yml
          vars/foundations/((foundation))/vars/director.yml
          vars/foundations/((foundation))/vars/iso-segment-gorouter-certs.yml

- name: apply-subproduct-changes
  serial: true
  serial_groups: [ install ]
  plan:
  - in_parallel:
    - get: platform-automation-image
      params:
        unpack: true
    - get: state
      passed:
      - apply-main-product-changes
      - configure-healthwatch
      - configure-healthwatch-pas-exporter
      - configure-isolation-segment
      trigger: true
    - get: platform-automation-tasks
    - get: configuration
  - task: prepare-tasks-with-secrets
    <<: *prepare-tasks-with-secrets
  - task: pre-deploy-check
    image: platform-automation-image
    file: platform-automation-tasks/tasks/pre-deploy-check.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
  - task: apply-product-changes
    attempts: 3
    image: platform-automation-image
    file: platform-automation-tasks/tasks/apply-changes.yml
    input_mapping:
      env: configuration
    params:
      ENV_FILE: foundations/config/env.yml
      SELECTIVE_DEPLOY_PRODUCTS: "p-bosh,p-isolation-segment,p-isolation-segment-iso-bank,p-healthwatch2,p-healthwatch2-pas-exporter"
      # SELECTIVE_DEPLOY_PRODUCTS: "p-bosh,p-isolation-segment,p-isolation-segment-iso-bank,p-healthwatch2,p-healthwatch2-pas-exporter,p-healthwatch2-pks-exporter"

# - name: collect-telemetry
#   serial: true
#   serial_groups: [ install ]
#   plan:
#   - in_parallel:
#     - get: telemetry-collector-binary
#       params:
#         unpack: true
#     - get: platform-automation-image
#       params:
#         unpack: true
#       passed:
#       - apply-product-changes
#       trigger: true
#     - get: platform-automation-tasks
#     - get: configuration
#   - task: prepare-tasks-with-secrets
#     <<: *prepare-tasks-with-secrets
#   # code_snippet collect-telemetry-usage start yaml
#   - task: collect-telemetry-data
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/collect-telemetry.yml
#     input_mapping:
#       env: configuration
#       config: configuration
#     params:
#       CONFIG_FILE: foundations/((foundation))/config/telemetry.yml
#       ENV_FILE: foundations/config/env.yml
#   # code_snippet collect-telemetry-usage end
#   # code_snippet send-telemetry-usage start yaml
#   - task: send-telemetry-data
#     attempts: 3
#     image: platform-automation-image
#     file: platform-automation-tasks/tasks/send-telemetry.yml
#     params:
#       API_KEY: no-op-test-key
#       DATA_FILE_PATH: collected-telemetry-data/FoundationDetails*.tar

# - name: expiring-certificates
#   serial: true
#   serial_groups: [ install ]
#   plan:
#     - in_parallel:
#       - get: platform-automation-image
#         params:
#           unpack: true
#         trigger: true
#       - get: platform-automation-tasks
#       - get: configuration
#       - get: state
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     # code_snippet expiring-certificates-usage start yaml
#     - task: expiring-certificates
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/expiring-certificates.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#         EXPIRES_WITHIN: 2m
    
# - name: stage-configure-apply-telemetry
#   serial_groups: [install]
#   plan:
#     - in_parallel:
#       - get: platform-automation-image
#         params:
#           unpack: true
#         passed:
#           - apply-product-changes
#         trigger: true
#       - get: platform-automation-tasks
#       - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     # code_snippet stage-configure-apply-usage start yaml
#     - task: stage-configure-apply
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/stage-configure-apply.yml
#       attempts: 3
#       params:
#         CONFIG_FILE: foundations/((foundation))/config/p-telemetry.yml
#         STAGE_PRODUCT_CONFIG_FILE: foundations/((foundation))/config/p-telemetry.yml
#         ENV_FILE: foundations/config/env.yml
#         VARS_FILES: |
#           vars/foundations/((foundation))/vars/director.yml
#       input_mapping:
#         env: configuration
#         config: configuration
#         vars: configuration
#     # code_snippet stage-configure-apply-usage end

- name: delete-installation
  serial: true
  serial_groups: [install]
  plan:
    - in_parallel:
      - get: platform-automation-image
        params:
          unpack: true
      - get: platform-automation-tasks
      - get: configuration
      - get: state
    - task: prepare-tasks-with-secrets
      <<: *prepare-tasks-with-secrets
    - task: delete-installation
      image: platform-automation-image
      file: platform-automation-tasks/tasks/delete-installation.yml
      input_mapping:
        env: configuration
      params:
        ENV_FILE: foundations/config/env.yml
    - task: delete-vm
      image: platform-automation-image
      file: platform-automation-tasks/tasks/delete-vm.yml
      input_mapping:
        config: configuration
      params:
        OPSMAN_CONFIG_FILE: foundations/((foundation))/config/opsman.yml
        STATE_FILE: state-((foundation)).yml
        VARS_FILES: config/foundations/((foundation))/vars/director.yml
      ensure:
        do:
        - put: state
          params:
            file: generated-state/state-((foundation)).yml

# - name: create-root-ca
#   plan:
#     - in_parallel:
#         - get: platform-automation-image
#           params:
#             unpack: true
#         - get: platform-automation-tasks
#         - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     # code_snippet configure-new-certificate-authority-usage start yaml
#     - task: create-root-ca
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/configure-new-certificate-authority.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#     # code_snippet configure-new-certificate-authority-usage end

# - name: apply-new-ca
#   serial: true
#   plan:
#     - in_parallel:
#         - get: platform-automation-image
#           params:
#             unpack: true
#           passed:
#             - create-root-ca
#         - get: platform-automation-tasks
#         - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     - task: pre-deploy-check
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/pre-deploy-check.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#     - task: apply-product-changes
#       attempts: 3
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/apply-changes.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#         SELECTIVE_DEPLOY_PRODUCTS: "cf,p-bosh,p-healthwatch2,p-healthwatch2-pas-exporter,pivotal-telemetry-om"

# - name: activate-new-ca-and-regenerate-certs
#   serial: true
#   plan:
#     - in_parallel:
#         - get: platform-automation-image
#           params:
#             unpack: true
#           passed:
#             - apply-new-ca
#         - get: platform-automation-tasks
#         - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     # code_snippet activate-certificate-authority-usage start yaml
#     - task: activate-new-ca
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/activate-certificate-authority.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#     # code_snippet activate-certificate-authority-usage end
#     # code_snippet regenerate-certificates-usage start yaml
#     - task: regenerate-certificates
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/regenerate-certificates.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#     # code_snippet regenerate-certificates-usage end

# - name: apply-certificates
#   serial: true
#   plan:
#     - in_parallel:
#         - get: platform-automation-image
#           params:
#             unpack: true
#           passed:
#             - activate-new-ca-and-regenerate-certs
#         - get: platform-automation-tasks
#         - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     - task: pre-deploy-check
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/pre-deploy-check.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#     - task: apply-product-changes
#       attempts: 3
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/apply-changes.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#         SELECTIVE_DEPLOY_PRODUCTS: "cf,p-bosh,p-healthwatch2,p-healthwatch2-pas-exporter,pivotal-telemetry-om"

# - name: cleanup-ca-certificate-authorities
#   serial: true
#   plan:
#     - in_parallel:
#         - get: platform-automation-image
#           params:
#             unpack: true
#           passed:
#             - apply-certificates
#         - get: platform-automation-tasks
#         - get: configuration
#     - task: prepare-tasks-with-secrets
#       <<: *prepare-tasks-with-secrets
#     # code_snippet delete-certificate-authority-usage start yaml
#     - task: delete-certificate-authority
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/delete-certificate-authority.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#     # code_snippet delete-certificate-authority-usage end
#     - task: pre-deploy-check
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/pre-deploy-check.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#     - task: apply-product-changes
#       attempts: 3
#       image: platform-automation-image
#       file: platform-automation-tasks/tasks/apply-changes.yml
#       input_mapping:
#         env: configuration
#       params:
#         ENV_FILE: foundations/config/env.yml
#         SELECTIVE_DEPLOY_PRODUCTS: "cf,p-bosh,p-healthwatch2,p-healthwatch2-pas-exporter,pivotal-telemetry-om"

